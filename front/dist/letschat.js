// Generated by CoffeeScript 1.9.2

/*
 * Copyright (C) 2014-2016 Andrey Antukh <niwi@niwi.nz>
 * Copyright (C) 2014-2016 Jesús Espino Garcia <jespinog@gmail.com>
 * Copyright (C) 2014-2016 David Barragán Merino <bameda@dbarragan.com>
 * Copyright (C) 2014-2016 Alejandro Alonso <alejandro.alonso@kaleidos.net>
 * Copyright (C) 2014-2016 Juan Francisco Alcántara <juanfran.alcantara@kaleidos.net>
 * Copyright (C) 2014-2016 Xavi Julian <xavier.julian@kaleidos.net>
 * Copyright (C) 2014-2016 Andrea Stagi <stagi.andrea@gmail.com>
#
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
#
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
#
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
#
 * File: letschat.coffee
 */

(function() {
  var LetsChatAdmin, LetsChatWebhooksDirective, debounce, initLetsChatPlugin, module;

  debounce = function(wait, func) {
    return _.debounce(func, wait, {
      leading: true,
      trailing: false
    });
  };

  LetsChatAdmin = (function() {
    LetsChatAdmin.$inject = ["$rootScope", "$scope", "$tgRepo", "tgAppMetaService", "$tgConfirm", "$tgHttp"];

    function LetsChatAdmin(rootScope, scope, repo, appMetaService, confirm, http) {
      this.rootScope = rootScope;
      this.scope = scope;
      this.repo = repo;
      this.appMetaService = appMetaService;
      this.confirm = confirm;
      this.http = http;
      this.scope.sectionName = "Let's Chat";
      this.scope.sectionSlug = "letschat";
      this.scope.$on("project:loaded", (function(_this) {
        return function() {
          var promise;
          promise = _this.repo.queryMany("letschat", {
            project: _this.scope.projectId
          });
          promise.then(function(letschathooks) {
            var description, title;
            _this.scope.letschathook = {
              project: _this.scope.projectId,
              notify_userstory_create: true,
              notify_userstory_change: true,
              notify_userstory_delete: true,
              notify_task_create: true,
              notify_task_change: true,
              notify_task_delete: true,
              notify_issue_create: true,
              notify_issue_change: true,
              notify_issue_delete: true,
              notify_wikipage_create: true,
              notify_wikipage_change: true,
              notify_wikipage_delete: true
            };
            if (letschathooks.length > 0) {
              _this.scope.letschathook = letschathooks[0];
            }
            title = _this.scope.sectionName + " - Plugins - " + _this.scope.project.name;
            description = _this.scope.project.description;
            return _this.appMetaService.setAll(title, description);
          });
          return promise.then(null, function() {
            return _this.confirm.notify("error");
          });
        };
      })(this));
    }

    LetsChatAdmin.prototype.testHook = function() {
      var promise;
      promise = this.http.post(this.repo.resolveUrlForModel(this.scope.letschathook) + '/test');
      promise.success((function(_this) {
        return function(_data, _status) {
          return _this.confirm.notify("success");
        };
      })(this));
      return promise.error((function(_this) {
        return function(data, status) {
          return _this.confirm.notify("error");
        };
      })(this));
    };

    return LetsChatAdmin;

  })();

  LetsChatWebhooksDirective = function($repo, $confirm, $loading) {
    var link;
    link = function($scope, $el, $attrs) {
      var form, submit, submitButton;
      form = $el.find("form").checksley({
        "onlyOneErrorElement": true
      });
      submit = debounce(2000, (function(_this) {
        return function(event) {
          var currentLoading, promise;
          event.preventDefault();
          if (!form.validate()) {
            return;
          }
          currentLoading = $loading().target(submitButton).start();
          if (!$scope.letschathook.id) {
            promise = $repo.create("letschat", $scope.letschathook);
            promise.then(function(data) {
              return $scope.letschathook = data;
            });
          } else if ($scope.letschathook.url) {
            promise = $repo.save($scope.letschathook);
            promise.then(function(data) {
              return $scope.letschathook = data;
            });
          } else {
            promise = $repo.remove($scope.letschathook);
            promise.then(function(data) {
              return $scope.letschathook = {
                project: $scope.projectId,
                notify_userstory_create: true,
                notify_userstory_change: true,
                notify_userstory_delete: true,
                notify_task_create: true,
                notify_task_change: true,
                notify_task_delete: true,
                notify_issue_create: true,
                notify_issue_change: true,
                notify_issue_delete: true,
                notify_wikipage_create: true,
                notify_wikipage_change: true,
                notify_wikipage_delete: true
              };
            });
          }
          promise.then(function(data) {
            currentLoading.finish();
            return $confirm.notify("success");
          });
          return promise.then(null, function(data) {
            currentLoading.finish();
            form.setErrors(data);
            if (data._error_message) {
              return $confirm.notify("error", data._error_message);
            }
          });
        };
      })(this));
      submitButton = $el.find(".submit-button");
      $el.on("submit", "form", submit);
      return $el.on("click", ".submit-button", submit);
    };
    return {
      link: link
    };
  };

  module = angular.module('taigaContrib.letschat', []);

  module.controller("ContribLetsChatAdminController", LetsChatAdmin);

  module.directive("contribLetschatWebhooks", ["$tgRepo", "$tgConfirm", "$tgLoading", LetsChatWebhooksDirective]);

  initLetsChatPlugin = function($tgUrls) {
    return $tgUrls.update({
      "letschat": "/letschat"
    });
  };

  module.run(["$tgUrls", initLetsChatPlugin]);

  module.run([
    '$templateCache', function($templateCache) {
      return $templateCache.put('plugin/letschat', '<div contrib-letschat-webhooks="contrib-letschat-webhooks" ng-controller="ContribLetsChatAdminController as ctrl"><header><h1><span class="project-name">{{::project.name}}</span><span class="green">{{::sectionName}}</span></h1></header><form><label for="url">Let\'s Chat webhook url</label><div class="contrib-form-wrapper"><fieldset class="contrib-input"><input type="text" name="url" ng-model="letschathook.url" placeholder="Let\'s Chat messages endpoint" id="url"/></fieldset><fieldset ng-show="letschathook.id"><a href="" title="Test" ng-click="ctrl.testHook()" class="button-gray"><span>Test</span></a></fieldset></div><label for="token">Let\'s Chat Auth token</label><div class="contrib-form-wrapper"><fieldset class="contrib-input"><input type="text" name="token" ng-model="letschathook.token" placeholder="Let\'s Chat auth token" id="token"/></fieldset></div><fieldset><h2>Notify User Stories</h2><div class="check-item"><span>Create</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_userstory_create"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Change</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_userstory_change"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Delete</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_userstory_delete"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div></fieldset><fieldset><h2>Notify Tasks</h2><div class="check-item"><span>Create</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_task_create"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Change</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_task_change"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Delete</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_task_delete"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div></fieldset><fieldset><h2>Notify Issues</h2><div class="check-item"><span>Create</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_issue_create"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Change</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_issue_change"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Delete</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_issue_delete"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div></fieldset><fieldset><h2>Notify Wiki</h2><div class="check-item"><span>Create</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_wikipage_create"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Change</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_wikipage_change"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div><div class="check-item"><span>Delete</span><div class="check"><input type="checkbox" name="notification" ng-model="letschathook.notify_wikipage_delete"/><div></div><span translate="COMMON.YES" class="check-text check-yes"></span><span translate="COMMON.NO" class="check-text check-no"></span></div></div></fieldset><button type="submit" class="hidden"></button><a href="" title="Save" ng-click="ctrl.updateOrCreateHook(letschathook)" class="button-green submit-button"><span>Save</span></a></form><div class="help-button"><span class="icon icon-help"></span><span>Let\'s Chat messages endpoint :host/rooms/:room_id_or_slug/messages <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>For example: <a>http:\/\/localhost:5000\/rooms\/54eafca13b8263d2cb5a48b1\/messages</a></span></div></div>');
    }
  ]);

}).call(this);
